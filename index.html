<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>冠智的市調評估</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .overlay {
      max-width: 380px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    input, select, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 8px;
      font-size: 15px;
    }
    .qa-card {
      background: #f9f9f9;
      padding: 6px 8px;
      margin-top: 6px;
      font-size: 14px;
      border-radius: 6px;
    }
    .question { font-weight: 600; }
    .answer { margin-top: 4px; }
  </style>
</head>
<body>
  <div class="overlay">
    <!-- 基本資料 -->
    <div id="basicInfoSection">
      <h2>冠智關心您－健檢問卷</h2>
      <label>姓名：</label>
      <input id="name" type="text" required />
      <label>聯絡電話：</label>
      <input id="phone" type="tel" required />
      <label>Line ID：</label>
      <input id="lineId" type="text" required />
      <label>生日：</label>
      <input id="birthday" type="date" required />
      <button id="nextBtn" type="button">下一步</button>
    </div>

    <!-- 問卷部分 -->
    <div id="questionSection" style="display:none">
      <div id="jobSection">
        <label>請選擇您的職業類別：</label>
        <select id="job">
          <option value="">請選擇</option>
          <option value="一般上班族">一般上班族</option>
          <option value="自營業者">自營業者</option>
          <option value="領導主管">領導主管</option>
          <option value="計程車司機">計程車司機</option>
          <option value="公職/醫療">公職/醫療</option>
        </select>
      </div>
      <form id="questionForm"></form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const spinQuestions = {
        "一般上班族": [
          { q: "你現在做的這份工作穩定嗎？", options: ["穩定", "偶爾變動", "很不穩定"] },
          { q: "這份工作對你來說壓力大不大？", options: ["正常", "壓力大", "非常疲憊"] },
          { q: "你目前有固定在儲蓄嗎？", options: ["有固定存","幾乎沒存"] },
          { q: "公司有提撥勞退，你還有另外規劃退休金嗎？", options: ["有額外規劃", "想規劃但還沒做", "沒有規劃"] },
          { q: "若突發大筆支出，你覺得夠用嗎？", options: ["可能夠", "完全沒有準備"] }
        ]
      };

      const $ = id => document.getElementById(id);
      const show = (id, f) => { $(id).style.display = f ? 'block' : 'none'; };

      $('nextBtn').addEventListener('click', () => {
        if (!($('name').value && $('phone').value && $('lineId').value && $('birthday').value)) {
          alert('請完整填寫所有基本資料！');
          return;
        }
        show('basicInfoSection', false);
        show('questionSection', true);
      });

      $('job').addEventListener('change', () => buildQuestions());

      function buildQuestions () {
        const job = $('job').value;
        const qs = spinQuestions[job] || [];
        const form = $('questionForm');
        form.innerHTML = '';
        qs.forEach((item, i) => {
          form.insertAdjacentHTML('beforeend', `<label>Q${i+1}. ${item.q}</label>`);
          item.options.forEach(opt => {
            form.insertAdjacentHTML('beforeend', `
              <div><input type="radio" name="q${i}" value="${opt}" required> ${opt}</div>
            `);
          });
        });

        const btn = document.createElement('button');
        btn.textContent = '開始評估';
        btn.type = 'button';
        btn.style.marginTop = '25px';
        btn.onclick = () => showResult(qs);
        form.appendChild(btn);
      }

      async function showResult(qs) {
        const form = $('questionForm');
        const ans = qs.map((_, i) => form.querySelector(`input[name="q${i}"]:checked`));
        const miss = ans.findIndex(a => !a);
        if (miss !== -1) return alert(`請回答第 ${miss + 1} 題！`);

        $('jobSection').style.display = 'none';
        form.innerHTML = '';

        const box = document.createElement('div');
        box.className = 'result-container';
        box.style.maxWidth = '340px';
        box.style.margin = '0 auto';

        box.innerHTML = `
          <p style="background:#fffae6;border:1px solid #f2c94c;
                    padding:10px;text-align:center;font-weight:600;
                    margin-bottom:15px;">
            請自行截圖此評估結果，傳送至 LINE 諮詢
          </p>`;

        box.innerHTML += `
          <table style="width:100%;border:1px solid #ddd;font-size:15px">
            <tr><th style="width:35%">姓名</th><td>${$('name').value}</td></tr>
            <tr><th>電話</th><td>${$('phone').value}</td></tr>
            <tr><th>Line ID</th><td>${$('lineId').value}</td></tr>
            <tr><th>生日</th><td>${$('birthday').value}</td></tr>
            <tr><th>職業</th><td>${$('job').value}</td></tr>
          </table>`;

        qs.forEach((item, i) => {
          box.insertAdjacentHTML('beforeend', `
            <div class="qa-card">
              <div class="question">Q${i+1}. ${item.q}</div>
              <div class="answer">👉 ${ans[i].value}</div>
            </div>`);
        });

        form.appendChild(box);

        const btnWrap = document.createElement('div');
        btnWrap.style.cssText = 'text-align:center;margin:20px 0;';
        const addUrl = `https://line.me/R/ti/p/%40637zzurf`;

        const lineA = document.createElement('a');
        lineA.textContent = 'LINE 諮詢';
        lineA.href = addUrl;
        lineA.target = '_blank';
        lineA.style.cssText = `
          display:inline-block;padding:8px 16px;font-size:15px;
          background:#06c755;color:#fff;border:none;border-radius:6px;
          cursor:pointer;text-decoration:none;`;

        lineA.addEventListener('click', e => {
          const ua = navigator.userAgent;
          const isIOS = /\(iP(hone|od|ad);/i.test(ua);
          const isAndroid = /\bAndroid\b/i.test(ua) && !/Windows/i.test(ua);
          const scheme = `line://ti/p/637zzurf`;
          if (isIOS || isAndroid) {
            e.preventDefault();
            location.href = scheme;
            setTimeout(() => location.href = addUrl, 800);
          }
        });

        btnWrap.appendChild(lineA);
        box.appendChild(btnWrap);
        box.scrollIntoView({ behavior: 'smooth' });

        // 等待畫面穩定後再截圖（使用者可手動截圖）
        await html2canvas(box, { scale: 2 });
      }
    });
  </script>
</body>
</html>
